#[include mainsail.cfg]

# host MCU service is preinstalled and ready to use with:
#[mcu CB1]
#serial: /tmp/klipper_host_mcu

#[include generic-bigtreetech-xxx.cfg]

# This file contains common pin mappings for the BIGTREETECH SKR V1.4
# board. To use this config, the firmware should be compiled for the
# LPC1768.

# See docs/Config_Reference.md for a description of parameters.
[include macros_voron.cfg]
[include mainsail.cfg]
[include stealthburner_leds.cfg]
[include timelapse.cfg]
[exclude_object]
[include eddy.cfg]
[include config_backup.cfg]
#[include klicky-probe.cfg]
#[include legacy.cfg]

[stepper_x]
enable_pin: !P2.1
step_pin: P2.2
dir_pin: P2.6
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: P1.26
position_min: 0
position_endstop: 235
position_max: 235
homing_speed: 50.0
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: P1.10
run_current: 1.3
hold_current: 0.950
interpolate: False
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_y]
enable_pin: !P2.8
step_pin: P0.19
dir_pin: P0.20
rotation_distance: 40
microsteps: 32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: P1.25
position_min: 0
position_endstop: 230
position_max: 230
homing_speed: 50.0
homing_positive_dir: true

[tmc2209 stepper_y]
uart_pin: P1.9
run_current: 1.3
hold_current: 0.950
interpolate: False
sense_resistor: 0.110
stealthchop_threshold: 0

[stepper_z1]
enable_pin: !P0.21
step_pin: P0.22
dir_pin: P2.11
#step_distance: 0.0025
rotation_distance: 8 
microsteps: 32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: probe:z_virtual_endstop
#position_max: 240
#position_min: -5
#homing_speed: 15.0

[tmc2209 stepper_z1]
uart_pin: P1.8
run_current: 1
interpolate: False
sense_resistor: 0.110
stealthchop_threshold: 9999

[stepper_z]
step_pin: P1.15
dir_pin: P1.14
enable_pin: !P1.16
# Rotation Distance for TR8x8 = 8, TR8x4 = 4, TR8x2 = 2
rotation_distance: 8   
microsteps: 32
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
endstop_pin: probe:z_virtual_endstop
position_max: 235
position_min: -2
homing_speed: 15.0

[tmc2209 stepper_z]
uart_pin: P1.1
run_current: 1
interpolate: False
sense_resistor: 0.110
stealthchop_threshold: 9999

#[homing_override]
#set_position_z: 0
#set_position_x: 0
#set_position_y: 0
#axes: xyz
#gcode:
#    G90
#    G0 Z5 F600
#    G28 X0 Y0
#    G0 X117.5 Y95 F5000
#    G28 Z0
#    G0 Z5 F500

[extruder]
step_pin: P2.13
dir_pin: !P0.11
enable_pin: !P2.12
##  Update value below when you perform extruder calibration
##  If you ask for 100mm of filament, but in reality it is 98mm:
##  rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100
##  22.6789511 is a good starting point
rotation_distance: 23 #22.6789511 #21.696 #21.92   #Bondtech 5mm Drive Gears
##  Update Gear Ratio depending on your Extruder Type
##  Use 50:10 for Stealthburner/Clockwork 2
##  Use 50:17 for Afterburner/Clockwork (BMG Gear Ratio)
##  Use 80:20 for M4, M3.1
gear_ratio: 50:10               #BMG Gear Ratio
microsteps: 32
full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: P2.7
#min_extrude_temp: 20
## Check what thermistor type you have. See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types.
## Use "Generic 3950" for NTC 100k 3950 thermistors
sensor_type: ATC Semitec 104NT-4-R025H42G #EPCOS 100K B57560G104F
sensor_pin: P0.23
#control: pid
#pid_kp: 19.171
#pid_ki: 0.814
#pid_kd: 112.871
min_temp: 0
max_temp: 290
max_power: 1.0
min_extrude_temp: 170
max_extrude_only_distance: 110
max_extrude_cross_section: 999999
pressure_advance: 0.05
pressure_advance_smooth_time: 0.040

[tmc2209 extruder]
uart_pin: P1.4
interpolate: false
run_current: 0.6
sense_resistor: 0.110
stealthchop_threshold: 0

[verify_heater extruder]
hysteresis: 10
max_error: 200
heating_gain: 5
check_gain_time:120

[heater_bed]
heater_pin: P2.5
## Check what thermistor type you have. See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types.
## Use "Generic 3950" for Keenovo heaters
#sensor_type:
sensor_pin: P0.25
sensor_type: ATC Semitec 104GT-2
#smooth_time: 3.0
#pwm_cycle_time: 0.0166
max_power: 1
#control: pid
#pid_Kp: 47.690
#pid_Ki: 1.556
#pid_Kd: 365.338
min_temp: 0
max_temp: 130

[fan]
pin: P2.4
kick_start_time: 0.1
#off_below: 0.2

#[controller_fan my_controller_fan]
#pin: P2.3
#max_power: 1.00
#kick_start_time: 0.200
#heater: heater_bed

# thermally controlled hotend fan
[heater_fan my_nozzle_fan]
pin: P2.3
max_power: 1.0
kick_start_time: 0.100
heater: extruder
heater_temp: 100.0
fan_speed: 0.5

#[bed_mesh]
#speed: 150
#horizontal_move_z: 5
#mesh_min: 30,30
#mesh_max: 205,200
#probe_count: 5,5
#algorithm:bicubic

#[safe_z_home]
#home_xy_position:175,175
#speed:300
#z_hop:5
#z_hop_speed:25

#[probe]
#pin: !P1.27
#y_offset: 25.0
#z_offset = -0.170
#speed: 15

[mcu]
serial: /dev/serial/by-path/platform-5311400.usb-usb-0:1:1.0
restart_method: command

[mcu host]
serial: /tmp/klipper_host_mcu

[adxl345]
cs_pin: host:gpio204
spi_bus: spidev1.2

[resonance_tester]
accel_chip: adxl345
accel_per_hz: 175
probe_points: 115,115,20 #117.5,117.5,10

[printer]
kinematics: corexy
max_velocity: 180
max_accel: 3000
max_z_velocity: 15
max_z_accel: 200
square_corner_velocity: 5.0

[z_tilt]
speed: 150
z_positions:
    283,95
    -40,95
points:
    20,95
    215,95

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=P1.30, EXP1_3=P1.18, EXP1_5=P1.20, EXP1_7=P1.22, EXP1_9=<GND>,
    EXP1_2=P0.28, EXP1_4=P1.19, EXP1_6=P1.21, EXP1_8=P1.23, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=P0.17, EXP2_3=P3.26, EXP2_5=P3.25, EXP2_7=P1.31, EXP2_9=<GND>,
    EXP2_2=P0.15, EXP2_4=P0.16, EXP2_6=P0.18, EXP2_8=<RST>, EXP2_10=<NC>
    # Pins EXP2_1, EXP2_6, EXP2_2 are also MISO, MOSI, SCK of bus "ssp0"

# See the sample-lcd.cfg file for definitions of common LCD displays.

##  mini12864 LCD Display
[display]
lcd_type: uc1701
cs_pin: EXP1_3
a0_pin: EXP1_4
rst_pin: EXP1_5
encoder_pins: ^EXP2_5, ^EXP2_3
click_pin: ^!EXP1_2
contrast: 63

##  To control Neopixel RGB in mini12864 display
[neopixel BTT_mini12864]
pin: EXP1_6
chain_count: 3
initial_RED: 0.1
initial_GREEN: 0.5
initial_BLUE: 0.0
color_order: RGB

##  Set RGB values on boot up for each Neopixel. 
##  Index 1 = display, Index 2 and 3 = Knob
[delayed_gcode setdisplayneopixel]
initial_duration: 1
gcode:
        SET_LED LED=BTT_mini12864 RED=1 GREEN=1 BLUE=1 INDEX=1 TRANSMIT=0
        SET_LED LED=BTT_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=2 TRANSMIT=0
        SET_LED LED=BTT_mini12864 RED=1 GREEN=0 BLUE=0 INDEX=3 

[gcode_macro DISABLE_MOTORS]
gcode:
    M18

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 42.131
#*# pid_ki = 5.401
#*# pid_kd = 82.155
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 69.417
#*# pid_ki = 3.673
#*# pid_kd = 327.995
#*#
#*# [probe]
#*# z_offset = 1.460
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.378247, -0.279270, -0.215401, -0.233498, -0.214510, -0.194490, -0.184590, -0.162772, -0.072934
#*# 	  -0.232418, -0.180155, -0.158504, -0.167256, -0.126264, -0.118576, -0.101397, -0.013087, -0.005037
#*# 	  -0.136743, -0.096165, -0.098781, -0.108268, -0.063311, -0.039487, -0.032279, -0.013713, 0.020013
#*# 	  -0.060765, -0.050208, -0.021841, -0.029204, -0.009028, 0.010659, -0.015396, 0.015215, 0.020492
#*# 	  -0.031358, 0.034623, 0.004665, 0.023485, 0.006946, 0.018924, 0.013933, 0.037081, 0.009938
#*# 	  -0.000615, 0.003806, 0.031203, 0.053584, 0.032291, 0.053420, 0.013651, 0.009938, 0.000956
#*# 	  -0.026600, 0.045581, 0.042307, 0.049996, 0.052604, 0.044920, 0.000957, 0.026481, -0.025067
#*# 	  0.022772, 0.033652, 0.051788, 0.031855, 0.082708, 0.044920, 0.007852, 0.008375, -0.017700
#*# 	  0.035280, 0.034468, 0.041331, 0.009942, 0.049170, 0.017496, -0.002183, -0.019383, -0.047779
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 204.96
#*# min_y = 30.0
#*# max_y = 204.96000000000004
#*#
#*# [input_shaper]
#*# shaper_type_x = 3hump_ei
#*# shaper_freq_x = 93.0
#*# shaper_type_y = mzv
#*# shaper_freq_y = 45.2
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3196425.955,0.090000:3196235.704,0.130000:3196040.889,
#*# 	0.170000:3195875.160,0.210000:3195688.464,0.250000:3195525.171,
#*# 	0.290000:3195371.292,0.330000:3195183.329,0.370000:3195025.629,
#*# 	0.410000:3194861.854,0.450000:3194694.158,0.490000:3194543.144,
#*# 	0.530000:3194364.438,0.570000:3194241.491,0.610000:3194076.404,
#*# 	0.650000:3193954.749,0.690000:3193799.218,0.730000:3193639.953,
#*# 	0.770000:3193498.785,0.810000:3193373.824,0.850000:3193206.329,
#*# 	0.890000:3193080.568,0.930000:3192944.959,0.970000:3192833.180,
#*# 	1.010000:3192699.281,1.050000:3192560.254,1.090000:3192434.796,
#*# 	1.130000:3192310.860,1.170000:3192179.821,1.210000:3192087.067,
#*# 	1.250000:3191965.209,1.290000:3191842.340,1.330000:3191719.061,
#*# 	1.370000:3191555.215,1.410000:3191487.683,1.450000:3191386.653,
#*# 	1.490000:3191259.076,1.530000:3191152.967,1.570000:3191062.476,
#*# 	1.610000:3190944.520,1.650000:3190834.997,1.690000:3190739.531,
#*# 	1.730000:3190639.241,1.770000:3190545.270,1.810000:3190448.640,
#*# 	1.850000:3190373.402,1.890000:3190234.680,1.930000:3190177.630,
#*# 	1.970000:3190082.336,2.010000:3189973.138,2.050000:3189871.675,
#*# 	2.090000:3189810.218,2.130000:3189715.030,2.170000:3189638.471,
#*# 	2.210000:3189547.254,2.250000:3189460.307,2.290000:3189355.057,
#*# 	2.330000:3189306.917,2.370000:3189240.377,2.410000:3189138.560,
#*# 	2.450000:3189047.085,2.490000:3188971.372,2.530000:3188887.820,
#*# 	2.570000:3188817.166,2.610000:3188735.667,2.650000:3188683.485,
#*# 	2.690000:3188610.829,2.730000:3188549.010,2.770000:3188476.306,
#*# 	2.810000:3188395.172,2.850000:3188325.067,2.890000:3188260.098,
#*# 	2.930000:3188187.802,2.970000:3188116.620,3.010000:3188078.636,
#*# 	3.050000:3187999.034,3.090000:3187941.402,3.130000:3187869.601,
#*# 	3.170000:3187809.547,3.210000:3187774.644,3.250000:3187694.382,
#*# 	3.290000:3187624.622,3.330000:3187573.738,3.370000:3187507.048,
#*# 	3.410000:3187463.554,3.450000:3187383.435,3.490000:3187341.895,
#*# 	3.530000:3187285.016,3.570000:3187238.653,3.610000:3187172.199,
#*# 	3.650000:3187126.345,3.690000:3187062.301,3.730000:3187012.903,
#*# 	3.770000:3186975.092,3.810000:3186923.273,3.850000:3186867.995,
#*# 	3.890000:3186829.471,3.930000:3186770.203,3.970000:3186691.657,
#*# 	4.010000:3186662.900,4.050000:3186619.127
#*# calibration_temp = 35.146022
#*# drift_calibration =
#*# 	3197882.687903, 79.093285, -1.164167
#*# 	3192853.119254, 161.417765, -1.899919
#*# 	3189651.759641, 187.368826, -2.094855
#*# 	3186732.164696, 220.447169, -2.374282
#*# 	3184746.088700, 230.957183, -2.450843
#*# 	3182979.817046, 241.199649, -2.506997
#*# 	3181674.323083, 243.763345, -2.506917
#*# 	3180122.383977, 264.205538, -2.691670
#*# 	3179305.761086, 261.373088, -2.643731
#*# drift_calibration_min_temp = 35.71614402263047
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 69.566550
